\section{Hyperfinite Sums}
\subsection{Hyperfinite Sets}
\begin{defn}
    An internal set $A = [A_n]$ is \textit{hyperfinite} if every $A_n$ is finite.
\end{defn}

The hyperfinite sets are ``internally finite.'' They share a lot of properties with finite sets.

\begin{thm}\label{HyperfiniteTransfer}
    If $\varphi(A)$ holds for every finite $A \subseteq \reals$, then $\hr{\varphi}(X)$ holds for every hyperfinite $X \subseteq \hreals$.
\end{thm}

\begin{proof}
    Say $X = [A_n]$, with each $A_n$ finite. Then $[[\varphi(A_n)]] = \nats$, and so by transfer $\hr{\varphi}(X)$.
\end{proof}

This lets us easily get a lot of nice properties about hyperfinite sets. For instance, $(\exists x \in A)(\forall y \in A) (x \geq y)$ ensures that every hyperfinite set has a maximum element.

\subsection{Hyperfinite Sums}
For any finite set $A_n$ and function $f_n: \reals \to \reals$, we can easily define the sum $\sum_{x \in A_n} f(x)$. This is, after all, just a sum of a finite collection of numbers. Using this, however, we can easily extend our summation to hyperfinite sets:

\begin{defn}
    If $A = [A_n]$ is a hyperfinite set, and $f = [f_n]$ is an internal function, we define the \textit{hyperfinite sum}
    \[\sum_{x \in [A_n]} f(x) = \left[\ \ \sum_{\mathclap{x \in A_n}} f_n(x) \:\right]\] %Why won't this space properly?
\end{defn}

We'll see this general form used later for integration, but for now we will focus on the type of hyperfinite sums that corresponds to series in standard calculus. Fist, some notation. Let $\{0\ldots n\}$ denote $\{0, 1, 2, \ldots, n\}$ for any $n \in \nats$. Then, let $\mathscr{N} = [\langle 0, 1, 2, \ldots \rangle]$, and let $\{0\ldots\mathscr{N}\}$ denote $[\{0\ldots n\}]$.

For a sequence $a_i: \nats \to \reals$, we have $\sum_{i \in \{0\ldots n\}} a_i = \sum_{i = 0}^n a_i$. So we denote $\sum_{i \in \{0\ldots \mathscr{N}\}} a_i = \sum_{i = 0}^\mathscr{N} a_i = \left[\sum_{i=0}^n a_i\right]$.

\begin{thm}[Geometric Series]\label{GeometricSeries}
    Let $0 < r < 1$. Then 
    \[ \sum_{i = 0}^\mathcal{N} r^i \simeq \frac{1}{1-r} \]
\end{thm}

\begin{proof}
    Let $S = \sum_{i = 0}^\mathcal{N} r^i$. Recall $\sum_{i = 0}^\mathcal{N} r^i = [\sum_{i = 0}^n r^i] = [\langle 1, 1 + r, 1 + r + r^2, \ldots \rangle]$. Then $r \cdot S = [\langle r, r + r^2, r + r^2 + r^3, \ldots \rangle]$, so $1 + r \cdot S = [\langle 1 + r, 1 + r + r^2, 1 + r + r^2 + r^3, \ldots \rangle]$. We conclude that $(1 + r \cdot S) - S = [\langle r, r^2, r^3, \ldots \rangle] \simeq 0$ (recall $0 < r < 1$). So we have $S \simeq 1 + r \cdot S$, and so $S \cdot (1 - r) \simeq 1$, and so since $1 - r$ is appreciable $S \simeq \frac{1}{1-r}$. 
\end{proof}

\begin{corollary}\label{LessThanGeometricSeries}
    For any $n \in \nats$, we have
    \[ \sum_{i = 0}^n r^i \leq \frac{1}{1-r} \]
\end{corollary}

\begin{proof}
    Let $f(n) = \sum_{i = 0}^n r^i$. Then the extension $f(\mathscr{N}) = [\sum_{i \in \{0\ldots n\}} r^i] = \sum_{i \in [\{0\ldots n\}]} r^i = \sum_{i = 0}^\mathscr{N} r^i$.

    Since $0 < r^i$, we have in the reals $(\forall m \in \nats)(\forall n \in \nats)(n < m \to f(n) < f(m))$. If we transfer this to the hyperreals and plug in $\mathcal{N}$ for $m$, we get $(\forall n \in \hnats)(n < \mathcal{N} \to f(n) < f(\mathcal N))$. Any $n \in \nats$ is in the hypernaturals and less than $\mathcal{N}$, and so for any $n \in \nats$ we have $f(n) < f(\mathcal{N}) \simeq \frac{1}{1-r}$. Since both $f(n)$ and $\frac{1}{1-r}$ are real, this implies $f(n) \leq \frac{1}{1-r}$.
\end{proof}

\begin{thm}[Absolute Convergence Implies Convergence]\label{AbsoluteConvergenceImpliesConvergence}
    If $\sum_{i = 0}^\mathcal{N} |a_i|$ is bounded, then $\sum_{i = 0}^\mathcal{N} a_i$ is bounded.
\end{thm}

\begin{proof}
    Say $\sum_{i = 0}^\mathcal{N} |a_i| < R$ for some real $R$. For any $n \in \nats$, we have $\left|\sum_{i = 0}^n a_i\right| \leq \sum_{i = 0}^n |a_i| < R$, and so $\left|\sum_{i = 0}^\mathcal{N} a_i\right| = \left|[\sum_{i=0}^n a_i]\right| < R$.
\end{proof}

\begin{thm}[Ratio Test]\label{RatioTest}
    Let $a_i: \nats \to \reals$ be a sequence. If for every unbounded $M \in \hnats$ we have $\left|\stp{\frac{a_{M+1}}{a_M}}\right| = L$ for some $L < 1$, then $\sum_{i=0}^\mathcal{N} a_i$ is bounded.
\end{thm}

\begin{proof}
    Assume that $a_i \geq 0$---if not, apply the theorem to $|a_i|$ and use \ref{AbsoluteConvergenceImpliesConvergence}. Now, take $r \in \reals$ such that $L < r < 1$, so that $\left|\frac{a_{M+1}}{a_M}\right| < r < 1$ for any unbounded hypernatural $M$.

    Take any unbounded $N \in \hnats$. For any $M \in \hnats$, if $N \leq M$, then $M$ is also unbounded, and so $\frac{a_{M+1}}{a_M} < r$. So we have the sentence
    \[ (\exists n \in \hnats)(\forall m \in \hnats)\left(n \leq m \to \frac{a_{m+1}}{a_m} < r\right) \]
    If we transfer this over to the reals, we find that there is some natural number $n$ such that for any natural $m \geq n$ we have $\frac{a_{m+1}}{a_m} < r$. Then clearly, for any $m > n$, we have 
    \begin{align*}
    \sum_{i = 0}^m a_i &= \sum_{i = 0}^n a_i + \sum_{i = n+1}^m a_i \\
        &\leq \sum_{i = 0}^n a_i + \sum_{i = n+1}^m a_n \cdot r^{i - n} \\
        &\leq \sum_{i = 0}^n a_i + a_n \cdot \sum_{i = 1}^{m-n}  r^{i} \leq \sum_{i = 0}^n a_i + a_n \cdot \frac{r}{1-r}
    \end{align*}
    Where that last inequality comes from \ref{LessThanGeometricSeries}.

    So, we find that there is some $n$ such that for any $m \geq n$, we have $\sum_{i = 0}^m a_i \leq \sum_{i = 0}^n a_i + a_n \cdot \frac{r}{1-r}$. We conclude that $\sum_{i = 0}^\mathcal{N} a_i \leq \sum_{i = 0}^n a_i + a_n \cdot \frac{r}{1-r}$, and hence that $\sum_{i = 0}^\mathcal{N} a_i$ is bounded.
\end{proof}

\subsection{The $\exp$ function}
We can define the exponential function \[\exp(x) = \stp{\sum_{i=0}^\mathcal{N} \frac{x^i}{i!}}\]

For convenience, we will write $e_k(x) = \sum_{i=0}^k \frac{x^i}{i!}$, and we will write $\inx(x)$ to denote the internal function $[e_k](x)$. Note that we have

\[\stp{\inx(x)} = \stp{[e_k](x)} = \stp{[e_k(x)]} = \stp{\left[\sum_{i=0}^k\frac{x^i}{i!}\right]} = \stp{\sum_{i=0}^\mathcal{N} \frac{x^i}{i!}} = \exp(x) \]

\begin{thm}\label{expExists}
    For any real $x$, $\exp(x)$ exists.
\end{thm}

\begin{proof}
    We use the ratio test (\ref{RatioTest}) to prove that $\sum_{i=0}^\mathcal{N} \frac{x^i}{i!}$ is bounded, and so has a standard part. Let $M$ be an unbounded hypernatural. Then 
    \[
        \frac{x^{M+1}}{(M+1)!} \  / \  \frac{x^M}{M!} = \frac{x^{M+1}M!}{x^M (M+1)!} 
        = \frac{x}{M+1}
    \]
    Since $x$ is real and $M+1$ is unbounded, $\frac{x}{M+1}$ is infinitesimal, and hence has standard part $0$. Since $0 < 1$, and since this holds for any unbounded hypernnatural, the conditions of \ref{RatioTest} are met and we are done.
\end{proof}

We now want to prove that $\exp'(x) = \exp(x)$. This will involve two lemmas, which I will assume during the proof and prove after the fact.

\begin{thm}
    For any real $x$, $\exp'(x) = \exp(x)$.
\end{thm}

\begin{proof}
    Let $\delta = [\delta_n]$ be a nonzero infinitesimal. We want to evaluate
    \[ \exp'(x) = \stp{\frac{\hr{\exp}(x + \delta) - \exp(x)}{\delta}} \]
    Consider
    \[ \frac{\hr{\exp}(x + \delta) - \exp(x)}{\delta} = \frac{[\exp(x+\delta_n)]_n - [\exp(x)]_n}{[\delta_n]_n} = \left[ \frac{\exp(x + \delta_n) - \exp(x)}{\delta_n} \right]_n \]
    Peeling back another layer, and remembering $\inx(x) = [e_k(x)]_k$,
    \begin{align*}
    \frac{\exp(x + \delta_n) - \exp(x)}{\delta_n} &\simeq \frac{\inx(x + \delta n) - \inx(x)}{\delta n} \\
    &= \left[ \frac{e_k(x + \delta_n) - e_k(x)}{\delta_n} \right]_k
    \end{align*}
    Now, let $R_n^k = \frac{1}{\delta_n}(e_k(x + \delta_n) - e_k(x) - \delta_n e_{k-1}(x))$ (that's an upper index, not an exponent). Then 
    \[ \frac{e_k(x+\delta_n) - e_k(x)}{\delta_n} = e_{k-1}(x) + R_n^k \]
    So, we have 
    \begin{align*}
    \frac{\exp(x + \delta_n) - \exp(x)}{\delta_n} &\simeq \left[ \frac{e_k(x + \delta_n) - e_k(x)}{\delta_n} \right]_k \\
    &= [e_{k-1}(x)]_k + [R_n^k]_k
    \end{align*}
    By our as-yet unproven lemma \ref{expDerivProofLemma1}, $[e_{k-1}(x)]_k \simeq \inx(x)$. So
    \[ \frac{\exp(x + \delta_n) - \exp(x)}{\delta_n} \simeq \inx(x) + [R_n^k]_k \]
    But the left side of this is real, and so must be the standard part of the right side
    \[ \frac{\exp(x + \delta_n) - \exp(x)}{\delta_n} = \stp{\inx(x) + [R_n^k]_k} = \exp(x) + \stp{[R_n^k]_k} \]
    So after all that, we have 
    \begin{align*}
    \frac{\hr{\exp}(x + \delta) - \exp(x)}{\delta} &= \left[ \frac{\exp(x + \delta_n) - \exp(x)}{\delta_n} \right]_n \\
        &= [\exp(x) + \stp{[R_n^k]_k}]_n = \exp(x) + [\stp{[R_n^k]_k}]_n
    \end{align*}
    By our as-yet unproven lemma \ref{expDerivProofLemma2}, $[\stp{[R_n^k]_k}]_n$ is infinitesimal, and so
    \begin{align*}
    \exp'(x) &= \stp{\frac{\hr{\exp}(x + \delta) - \exp(x)}{\delta}} \\
    &= \stp{\exp(x) + [\stp{[R_n^k]_k}]_n} = \exp(x)
    \end{align*}
\end{proof}

\begin{lemma}\label{expDerivProofLemma1}
    $[e_{n-1}(x)] \simeq \inx(x)$
\end{lemma}
\begin{proof}
    We want to show that $\inx(x) - [e_{n-1}(x)] \simeq 0$, i.e. that $[e_n(x) - e_{n-1}(x)] \simeq 0$, i.e. that $[\frac{x^n}{n!}] \simeq 0$. Note this is true iff $|[\frac{x^n}{n!}]| = [\frac{|x|^n}{n!}] \simeq 0$, so we can show that this is true for all positive $x$ and be done. If $[\frac{x^n}{n!}] \geq r$ for some positive real $r$, then we'd have $\frac{x^n}{n!} \geq r$ for $\mathcal{F}$-almost all $n$, hence for infinitely many $n$. Then clearly $\sum_{i = 0}^\mathcal{N} \frac{x^n}{n!}$ would be unbounded, and so $\exp(x)$ would be undefined---but we know by \ref{expExists} that this is false, and so our assumption that $\frac{x^n}{n!} \geq r$ must be false, hence $\frac{x^n}{n!} < r$ for any positive real $r$, and we are done.
\end{proof}

\begin{lemma}\label{expDerivProofLemma2}
    Let $R_n^k = \frac{1}{\delta_n}(e_k(x + \delta_n) - e_k(x) - \delta_n e_{k-1}(x))$. Then $[\stp{[R_n^k]_k}]_n$ is infinitesimal.
\end{lemma}

\begin{proof}
    First, we will find a more explicit formula for $R_n^k$. We have
    \[e_k(x + \delta_n) = 1 + x + \delta_n + \frac{x^2 + 2x\delta_n + \delta_n^2}{2!} + \cdots + \frac{x^k + kx^{k-1}\delta_n + \cdots + \delta_n^k}{k!} \]
    and so
    \begin{align*}
    e_k(x + \delta_n) - e_k(x) &= \delta_n + \frac{2x\delta_n + \delta_n^2}{2!} + \frac{3x^2\delta_n + 3x\delta_n^2 + \delta_n^3}{3!} + \cdots + \frac{kx^{k-1}\delta_n + \cdots + \delta_n^k}{k!} \\
        &= \delta_n\left(1 + \frac{2x}{2!} + \frac{3x^2}{3!} + \cdots + \frac{kx^{k-1}}{k!}\right) + \frac{\delta_n^2}{2!} + \frac{3x\delta_n^2 + \delta_n^3}{3!} + \cdots + \frac{\binom{k}{2} x^{k-2}\delta_n^2 + \cdots + \delta_n^k}{k!} \\
        &= \delta_n e_{k-1}(x) + \delta_n\left(\frac{\delta_n}{2!} + \frac{3x\delta_n + \delta_n^2}{3!} + \cdots + \frac{\binom{k}{2} x^{k-2}\delta_n + \cdots + \delta_n^{k-1}}{k!}\right)
    \end{align*}
    So we find that 
    \[R_n^k = \frac{\delta_n}{2!} + \frac{3x\delta_n + \delta_n^2}{3!} + \cdots + \frac{\binom{k}{2} x^{k-2}\delta_n + \cdots + \delta_n^{k-1}}{k!} = \sum_{i=1}^k \sum_{q=0}^{i-2} \binom{i}{q} \frac{x^q \delta_n^{(i-1-q)}}{i!}\]
    Using the fact that $\binom{i}{q} = \frac{i!}{q!(i-q!)}$, we have
    \begin{align*}
    R_n^k &= \sum_{i=1}^k \sum_{q=0}^{i-2} \binom{i}{q} \frac{x^q \delta_n^{(i-1-q)}}{i!} \\
        &= \sum_{i=2}^k \sum_{q=0}^{i-2}\frac{x^q\delta_n^{(i-1-q)}}{(i-q)!q!} \\
        &= \delta_n \sum_{i=2}^k \sum_{q=0}^{i-2} \frac{x^{q}\delta_n^{(i-2-q)}}{(i-q)!q!} \\
        &= \delta_n \sum_{q=0}^{k-2}\sum_{i=q+2}^k \frac{x^{q}\delta_n^{(i-2-q)}}{(i-q)!q!}
    \end{align*}
    Note then that
    \[ |R_n^k| = |\delta_n| \sum_{q=0}^{k-2}\sum_{i=q+2}^k \frac{|x|^q |\delta_n|^{(i-2-q)}}{(i-q)!q!} \]
    Now, note that $i - q \geq 2$ in every term, and so $(i-q)! \geq 2$ and hence $\frac{|x|^q |\delta_n|^{(i-2-q)}}{(i-q)!q!} \leq \frac{|x|^q |\delta_n|^{(i-2-q)}}{2q!}$. Combining this move with a change of index, setting $p = i - 2 - q$, we have
    \[ |R_n^k| \leq |\delta_n|\sum_{q=0}^{k-2} \sum_{p=0}^{k-2-q} \frac{|x|^q |\delta_n|^p}{2q!} = |\delta_n| \sum_{q=0}^{k-2} \left(\frac{|x|^q}{2q!} \cdot \sum_{p=0}^{k-2-q} |\delta_n|^p \right) \]
    By \ref{LessThanGeometricSeries}, assuming $|\delta_n| < 1$ (as $[\delta_n]$ is infinitesimal), we then have
    \[ |R_n^k| \leq |\delta_n|  \sum_{q=0}^{k-2}\left(\frac{|x|^q}{2q!} \cdot \frac{1}{1-|\delta_n|}\right) = \frac{|\delta_n|}{1-|\delta_n|} \sum_{q=0}^{k-2} \frac{|x|^q}{2q!} = \frac{|\delta_n|}{1-|\delta_n|} \cdot \frac{e_{k-2}(|x|)}{2}\]
    Now, for any $n$, we have
    \[ |\stp{[R_n^k]_k}| = \stp{[|R_n^k|]_k} \leq \stp{\left[\frac{|\delta_n|}{1-|\delta_n|} \cdot \frac{e_{k-2}(|x|)}{2}\right]_k} = \stp{\frac{|\delta_n|}{1-|\delta_n|} \cdot \frac{[e_{k-2}(|x|)]_k}{2}} = \frac{|\delta_n|}{1-|\delta_n|} \cdot \frac{\exp(|x|)}{2} \]
    (I am using here that $[e_{k-2}(x)] \simeq \inx(x)$, which is an easy extension of the reasoning in \ref{expDerivProofLemma1}). 

    Now, we want to show that $[\stp{[R_n^k]_k}]_n$ is infinitesimal, which is true iff $\left|[\stp{[R_n^k]_k}]_n\right|$ is infinitesimal. Then
    \[\left|[\stp{[R_n^k]_k}]_n\right| = [|\stp{[R_n^k]_k}|]_n \leq \left[\frac{|\delta_n|}{1-|\delta_n|} \cdot \frac{\exp(|x|)}{2}\right]_n = \frac{|\delta|}{1-|\delta|} \cdot \frac{\exp(|x|)}{2}\] 
    Since $|\delta|$ is a positive infinitesimal, $1 - |\delta|$ is appreciable. Similarly, $\frac{\exp(|x|)}{2}$ is positive and apprecaible. Hence, $\frac{|\delta|}{1-|\delta|} \cdot \frac{\exp(|x|)}{2}$ is a positive infinitesimal. Since $0 \leq \left|[\stp{[R_n^k]_k}]_n\right| \leq \frac{|\delta|}{1-|\delta|} \cdot \frac{\exp(|x|)}{2}$, we conclude $\left|[\stp{[R_n^k]_k}]_n\right|$ is infinitesimal, hence $[\stp{[R_n^k]_k}]_n$ is infinitesimal.
\end{proof}